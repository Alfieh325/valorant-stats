<script>
  async function getStats() {
  const errorDiv = document.getElementById('error');
  const resultsDiv = document.getElementById('results');
  const loadingDiv = document.getElementById('loading');

  // Guard against missing elements
  if (!errorDiv || !resultsDiv) {
    console.error('Missing DOM elements: error or results div not found');
    return;
  }

  if (errorDiv) errorDiv.textContent = '';
  if (resultsDiv) resultsDiv.innerHTML = '';
  if (loadingDiv) loadingDiv.style.display = 'block';

  const riotId = document.getElementById('riotId')?.value?.trim();
  const region = document.getElementById('region')?.value;

  if (!riotId || !riotId.includes('#')) {
    if (errorDiv) errorDiv.textContent = 'Please enter a valid Riot ID (Username#Tag)';
    if (loadingDiv) loadingDiv.style.display = 'none';
    return;
  }

  const [name, tag] = riotId.split('#');

  const apiKey = 'HDEV-d27bf45c-cb88-44ea-8e1c-620884f46705';  // ‚Üê make sure this is updated!

  try {
    // MMR fetch (v2 for better compatibility)
    const mmrRes = await fetch(
      `https://api.henrikdev.xyz/valorant/v2/mmr/${region}/${encodeURIComponent(name)}/${encodeURIComponent(tag)}`,
      { headers: { 'Authorization': apiKey } }
    );

    if (!mmrRes.ok) {
      let errMsg = 'Unknown error';
      try {
        const err = await mmrRes.json();
        errMsg = err?.data?.message || `HTTP ${mmrRes.status}`;
      } catch {
        errMsg = `HTTP ${mmrRes.status}`;
      }
      throw new Error(`Failed to load rank: ${errMsg} (check Riot ID, region, or if player has ranked games)`);
    }

    const mmrData = (await mmrRes.json()).data || {};

    // Matches fetch
    const matchesRes = await fetch(
      `https://api.henrikdev.xyz/valorant/v4/matches/${region}/${encodeURIComponent(name)}/${encodeURIComponent(tag)}?size=5`,
      { headers: { 'Authorization': apiKey } }
    );

    let matchesHtml = '<h3>Recent Matches</h3><p>No matches loaded.</p>';
    if (matchesRes.ok) {
      const matches = (await matchesRes.json()).data || [];
      if (matches.length > 0) {
        let table = '<table><tr><th>Mode</th><th>Map</th><th>K/D/A</th><th>Result</th></tr>';
        for (const match of matches) {
          const player = match.players?.all_players?.find(p => 
            p.name.toLowerCase() === name.toLowerCase() && p.tag.toLowerCase() === tag.toLowerCase()
          );
          if (player) {
            const kda = `${player.stats?.kills ?? '?'} / ${player.stats?.deaths ?? '?'} / ${player.stats?.assists ?? '?'}`;
            const won = player.stats?.won ? 'Win' : 'Loss';
            table += `<tr><td>${match.meta?.mode || '?'}</td><td>${match.meta?.map?.name || '?'}</td><td>${kda}</td><td style="color:${player.stats.won ? 'green' : 'red'}">${won}</td></tr>`;
          }
        }
        table += '</table>';
        matchesHtml = '<h3>Recent Matches</h3>' + table;
      }
    }

    const rankName = mmrData.currenttierpatched || 'Unranked';
    const rr = mmrData.ranking_in_tier ?? '?';

    if (resultsDiv) {
      resultsDiv.innerHTML = `
        <h2>${name}#${tag}</h2>
        <p>Rank: ${rankName} (${rr} RR)</p>
        ${matchesHtml}
      `;
    }
  } catch (err) {
    console.error('Fetch error:', err);
    if (errorDiv) errorDiv.textContent = err.message;
  } finally {
    if (loadingDiv) loadingDiv.style.display = 'none';
  }
}
